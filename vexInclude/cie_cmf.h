/*
 * PROPRIETARY INFORMATION.  This software is proprietary to
 * Side Effects Software Inc., and is not to be reproduced,
 * transmitted, or disclosed in any way without written permission.
 *
 * Produced by:
 *	Side Effects Software Inc
 *	477 Richmond Street West
 *	Toronto, Ontario
 *	Canada   M5V 3E7
 *	416-504-9876
 *
 * NAME:	cie_cmf.h ( VOP Library Functions, VEX )
 *
 * COMMENTS:	CIE Color Matching Functions
 *
 */

#ifndef __cie_cmf_h__
#define __cie_cmf_h__

//--------------------------------------------------------------------------------
// Spectrum and CIE color matching
//--------------------------------------------------------------------------------



// CIE 1931 Color Matching Functions (photopic, 2 degrees, standard observer)
// Tabulated for wavelengths in the 360 to 830 nanometer range (visible) in
// 5 nm intervals. The data is in CIE XYZ space, with the Y value set to
// the CIE 1931 eye sensitivity function V(lambda) in the photopic vision regime.
// Source: http://www.cvrl.org/database/data/cmfs/ciexyz31.csv
//------------------------------------------------------------------------------
#define CMF_WLSTART  380
#define CMF_WLEND    780
#define CMF_WLSTEP   5
#define CMF_NSTEPS   81
#define CMF_AVG      {0.468248, 0.298897, 0.2935929}

vector cmf_1931(int ndx)
{
   vector stdobserver_1931_2deg[] = {
      { 0.001368000000, 0.000039000000, 0.006450001000 }, // 380 nm
      { 0.002236000000, 0.000064000000, 0.010549990000 }, // 385 nm
      { 0.004243000000, 0.000120000000, 0.020050010000 }, // 390 nm
      { 0.007650000000, 0.000217000000, 0.036210000000 }, // 395 nm
      { 0.014310000000, 0.000396000000, 0.067850010000 }, // 400 nm
      { 0.023190000000, 0.000640000000, 0.110200000000 }, // 405 nm
      { 0.043510000000, 0.001210000000, 0.207400000000 }, // 410 nm
      { 0.077630000000, 0.002180000000, 0.371300000000 }, // 415 nm
      { 0.134380000000, 0.004000000000, 0.645600000000 }, // 420 nm
      { 0.214770000000, 0.007300000000, 1.039050100000 }, // 425 nm
      { 0.283900000000, 0.011600000000, 1.385600000000 }, // 430 nm
      { 0.328500000000, 0.016840000000, 1.622960000000 }, // 435 nm
      { 0.348280000000, 0.023000000000, 1.747060000000 }, // 440 nm
      { 0.348060000000, 0.029800000000, 1.782600000000 }, // 445 nm
      { 0.336200000000, 0.038000000000, 1.772110000000 }, // 450 nm
      { 0.318700000000, 0.048000000000, 1.744100000000 }, // 455 nm
      { 0.290800000000, 0.060000000000, 1.669200000000 }, // 460 nm
      { 0.251100000000, 0.073900000000, 1.528100000000 }, // 465 nm
      { 0.195360000000, 0.090980000000, 1.287640000000 }, // 470 nm
      { 0.142100000000, 0.112600000000, 1.041900000000 }, // 475 nm
      { 0.095640000000, 0.139020000000, 0.812950100000 }, // 480 nm
      { 0.057950010000, 0.169300000000, 0.616200000000 }, // 485 nm
      { 0.032010000000, 0.208020000000, 0.465180000000 }, // 490 nm
      { 0.014700000000, 0.258600000000, 0.353300000000 }, // 495 nm
      { 0.004900000000, 0.323000000000, 0.272000000000 }, // 500 nm
      { 0.002400000000, 0.407300000000, 0.212300000000 }, // 505 nm
      { 0.009300000000, 0.503000000000, 0.158200000000 }, // 510 nm
      { 0.029100000000, 0.608200000000, 0.111700000000 }, // 515 nm
      { 0.063270000000, 0.710000000000, 0.078249990000 }, // 520 nm
      { 0.109600000000, 0.793200000000, 0.057250010000 }, // 525 nm
      { 0.165500000000, 0.862000000000, 0.042160000000 }, // 530 nm
      { 0.225749900000, 0.914850100000, 0.029840000000 }, // 535 nm
      { 0.290400000000, 0.954000000000, 0.020300000000 }, // 540 nm
      { 0.359700000000, 0.980300000000, 0.013400000000 }, // 545 nm
      { 0.433449900000, 0.994950100000, 0.008749999000 }, // 550 nm
      { 0.512050100000, 1.000000000000, 0.005749999000 }, // 555 nm
      { 0.594500000000, 0.995000000000, 0.003900000000 }, // 560 nm
      { 0.678400000000, 0.978600000000, 0.002749999000 }, // 565 nm
      { 0.762100000000, 0.952000000000, 0.002100000000 }, // 570 nm
      { 0.842500000000, 0.915400000000, 0.001800000000 }, // 575 nm
      { 0.916300000000, 0.870000000000, 0.001650001000 }, // 580 nm
      { 0.978600000000, 0.816300000000, 0.001400000000 }, // 585 nm
      { 1.026300000000, 0.757000000000, 0.001100000000 }, // 590 nm
      { 1.056700000000, 0.694900000000, 0.001000000000 }, // 595 nm
      { 1.062200000000, 0.631000000000, 0.000800000000 }, // 600 nm
      { 1.045600000000, 0.566800000000, 0.000600000000 }, // 605 nm
      { 1.002600000000, 0.503000000000, 0.000340000000 }, // 610 nm
      { 0.938400000000, 0.441200000000, 0.000240000000 }, // 615 nm
      { 0.854449900000, 0.381000000000, 0.000190000000 }, // 620 nm
      { 0.751400000000, 0.321000000000, 0.000100000000 }, // 625 nm
      { 0.642400000000, 0.265000000000, 0.000049999990 }, // 630 nm
      { 0.541900000000, 0.217000000000, 0.000030000000 }, // 635 nm
      { 0.447900000000, 0.175000000000, 0.000020000000 }, // 640 nm
      { 0.360800000000, 0.138200000000, 0.000010000000 }, // 645 nm
      { 0.283500000000, 0.107000000000, 0.000000000000 }, // 650 nm
      { 0.218700000000, 0.081600000000, 0.000000000000 }, // 655 nm
      { 0.164900000000, 0.061000000000, 0.000000000000 }, // 660 nm
      { 0.121200000000, 0.044580000000, 0.000000000000 }, // 665 nm
      { 0.087400000000, 0.032000000000, 0.000000000000 }, // 670 nm
      { 0.063600000000, 0.023200000000, 0.000000000000 }, // 675 nm
      { 0.046770000000, 0.017000000000, 0.000000000000 }, // 680 nm
      { 0.032900000000, 0.011920000000, 0.000000000000 }, // 685 nm
      { 0.022700000000, 0.008210000000, 0.000000000000 }, // 690 nm
      { 0.015840000000, 0.005723000000, 0.000000000000 }, // 695 nm
      { 0.011359160000, 0.004102000000, 0.000000000000 }, // 700 nm
      { 0.008110916000, 0.002929000000, 0.000000000000 }, // 705 nm
      { 0.005790346000, 0.002091000000, 0.000000000000 }, // 710 nm
      { 0.004106457000, 0.001484000000, 0.000000000000 }, // 715 nm
      { 0.002899327000, 0.001047000000, 0.000000000000 }, // 720 nm
      { 0.002049190000, 0.000740000000, 0.000000000000 }, // 725 nm
      { 0.001439971000, 0.000520000000, 0.000000000000 }, // 730 nm
      { 0.000999949300, 0.000361100000, 0.000000000000 }, // 735 nm
      { 0.000690078600, 0.000249200000, 0.000000000000 }, // 740 nm
      { 0.000476021300, 0.000171900000, 0.000000000000 }, // 745 nm
      { 0.000332301100, 0.000120000000, 0.000000000000 }, // 750 nm
      { 0.000234826100, 0.000084800000, 0.000000000000 }, // 755 nm
      { 0.000166150500, 0.000060000000, 0.000000000000 }, // 760 nm
      { 0.000117413000, 0.000042400000, 0.000000000000 }, // 765 nm
      { 0.000083075270, 0.000030000000, 0.000000000000 }, // 770 nm
      { 0.000058706520, 0.000021200000, 0.000000000000 }, // 775 nm
      { 0.000041509940, 0.000014990000, 0.000000000000 }  // 780 nm
   };

   return stdobserver_1931_2deg[ndx];
}

vector cmf_1964(int ndx)
{
   vector stdobserver_1964_10deg[] = {
      { 0.000159952000, 0.000017364000, 0.000704776000 }, // 380 nm
      { 0.000662440000, 0.000071560000, 0.002927800000 }, // 385 nm
      { 0.002361600000, 0.000253400000, 0.010482200000 }, // 390 nm
      { 0.007242300000, 0.000768500000, 0.032344000000 }, // 395 nm
      { 0.019109700000, 0.002004400000, 0.086010900000 }, // 400 nm
      { 0.043400000000, 0.004509000000, 0.197120000000 }, // 405 nm
      { 0.084736000000, 0.008756000000, 0.389366000000 }, // 410 nm
      { 0.140638000000, 0.014456000000, 0.656760000000 }, // 415 nm
      { 0.204492000000, 0.021391000000, 0.972542000000 }, // 420 nm
      { 0.264737000000, 0.029497000000, 1.282500000000 }, // 425 nm
      { 0.314679000000, 0.038676000000, 1.553480000000 }, // 430 nm
      { 0.357719000000, 0.049602000000, 1.798500000000 }, // 435 nm
      { 0.383734000000, 0.062077000000, 1.967280000000 }, // 440 nm
      { 0.386726000000, 0.074704000000, 2.027300000000 }, // 445 nm
      { 0.370702000000, 0.089456000000, 1.994800000000 }, // 450 nm
      { 0.342957000000, 0.106256000000, 1.900700000000 }, // 455 nm
      { 0.302273000000, 0.128201000000, 1.745370000000 }, // 460 nm
      { 0.254085000000, 0.152761000000, 1.554900000000 }, // 465 nm
      { 0.195618000000, 0.185190000000, 1.317560000000 }, // 470 nm
      { 0.132349000000, 0.219940000000, 1.030200000000 }, // 475 nm
      { 0.080507000000, 0.253589000000, 0.772125000000 }, // 480 nm
      { 0.041072000000, 0.297665000000, 0.570060000000 }, // 485 nm
      { 0.016172000000, 0.339133000000, 0.415254000000 }, // 490 nm
      { 0.005132000000, 0.395379000000, 0.302356000000 }, // 495 nm
      { 0.003816000000, 0.460777000000, 0.218502000000 }, // 500 nm
      { 0.015444000000, 0.531360000000, 0.159249000000 }, // 505 nm
      { 0.037465000000, 0.606741000000, 0.112044000000 }, // 510 nm
      { 0.071358000000, 0.685660000000, 0.082248000000 }, // 515 nm
      { 0.117749000000, 0.761757000000, 0.060709000000 }, // 520 nm
      { 0.172953000000, 0.823330000000, 0.043050000000 }, // 525 nm
      { 0.236491000000, 0.875211000000, 0.030451000000 }, // 530 nm
      { 0.304213000000, 0.923810000000, 0.020584000000 }, // 535 nm
      { 0.376772000000, 0.961988000000, 0.013676000000 }, // 540 nm
      { 0.451584000000, 0.982200000000, 0.007918000000 }, // 545 nm
      { 0.529826000000, 0.991761000000, 0.003988000000 }, // 550 nm
      { 0.616053000000, 0.999110000000, 0.001091000000 }, // 555 nm
      { 0.705224000000, 0.997340000000, 0.000000000000 }, // 560 nm
      { 0.793832000000, 0.982380000000, 0.000000000000 }, // 565 nm
      { 0.878655000000, 0.955552000000, 0.000000000000 }, // 570 nm
      { 0.951162000000, 0.915175000000, 0.000000000000 }, // 575 nm
      { 1.014160000000, 0.868934000000, 0.000000000000 }, // 580 nm
      { 1.074300000000, 0.825623000000, 0.000000000000 }, // 585 nm
      { 1.118520000000, 0.777405000000, 0.000000000000 }, // 590 nm
      { 1.134300000000, 0.720353000000, 0.000000000000 }, // 595 nm
      { 1.123990000000, 0.658341000000, 0.000000000000 }, // 600 nm
      { 1.089100000000, 0.593878000000, 0.000000000000 }, // 605 nm
      { 1.030480000000, 0.527963000000, 0.000000000000 }, // 610 nm
      { 0.950740000000, 0.461834000000, 0.000000000000 }, // 615 nm
      { 0.856297000000, 0.398057000000, 0.000000000000 }, // 620 nm
      { 0.754930000000, 0.339554000000, 0.000000000000 }, // 625 nm
      { 0.647467000000, 0.283493000000, 0.000000000000 }, // 630 nm
      { 0.535110000000, 0.228254000000, 0.000000000000 }, // 635 nm
      { 0.431567000000, 0.179828000000, 0.000000000000 }, // 640 nm
      { 0.343690000000, 0.140211000000, 0.000000000000 }, // 645 nm
      { 0.268329000000, 0.107633000000, 0.000000000000 }, // 650 nm
      { 0.204300000000, 0.081187000000, 0.000000000000 }, // 655 nm
      { 0.152568000000, 0.060281000000, 0.000000000000 }, // 660 nm
      { 0.112210000000, 0.044096000000, 0.000000000000 }, // 665 nm
      { 0.081260600000, 0.031800400000, 0.000000000000 }, // 670 nm
      { 0.057930000000, 0.022601700000, 0.000000000000 }, // 675 nm
      { 0.040850800000, 0.015905100000, 0.000000000000 }, // 680 nm
      { 0.028623000000, 0.011130300000, 0.000000000000 }, // 685 nm
      { 0.019941300000, 0.007748800000, 0.000000000000 }, // 690 nm
      { 0.013842000000, 0.005375100000, 0.000000000000 }, // 695 nm
      { 0.009576880000, 0.003717740000, 0.000000000000 }, // 700 nm
      { 0.006605200000, 0.002564560000, 0.000000000000 }, // 705 nm
      { 0.004552630000, 0.001768470000, 0.000000000000 }, // 710 nm
      { 0.003144700000, 0.001222390000, 0.000000000000 }, // 715 nm
      { 0.002174960000, 0.000846190000, 0.000000000000 }, // 720 nm
      { 0.001505700000, 0.000586440000, 0.000000000000 }, // 725 nm
      { 0.001044760000, 0.000407410000, 0.000000000000 }, // 730 nm
      { 0.000727450000, 0.000284041000, 0.000000000000 }, // 735 nm
      { 0.000508258000, 0.000198730000, 0.000000000000 }, // 740 nm
      { 0.000356380000, 0.000139550000, 0.000000000000 }, // 745 nm
      { 0.000250969000, 0.000098428000, 0.000000000000 }, // 750 nm
      { 0.000177730000, 0.000069819000, 0.000000000000 }, // 755 nm
      { 0.000126390000, 0.000049737000, 0.000000000000 }, // 760 nm
      { 0.000090151000, 0.000035540500, 0.000000000000 }, // 765 nm
      { 0.000064525800, 0.000025486000, 0.000000000000 }, // 770 nm
      { 0.000046339000, 0.000018338400, 0.000000000000 }, // 775 nm
      { 0.000033411700, 0.000013249000, 0.000000000000 }  // 780 nm
   };

   return stdobserver_1964_10deg[ndx];
}

vector cmf(int ndx)
{
    return cmf_1964(ndx);
}

float
cmf_find_wavelength_index(float wavelength)
{
	float pos = (wavelength - CMF_WLSTART) / (CMF_WLEND - CMF_WLSTART) ;
	float findex = pos * (float) (CMF_NSTEPS - 1);
	if (wavelength > CMF_WLEND || wavelength < CMF_WLSTART)
		return 5.0;
	else
		return findex;
}

vector
cmf_wavelength_to_color(const float wavelength)
{
    float index = cmf_find_wavelength_index(wavelength);

    float index_fraction = index % 1.0;
    int index_whole = int(floor(index));

    vector xyz_color_1 = cmf(index_whole);
    vector xyz_color_2 = cmf(index_whole+1);

    vector xyz_color = lerp(xyz_color_1, xyz_color_2, index_fraction);

    return clamp(xyztorgb(xyz_color), {0.0, 0.0, 0.0}, {10000.0, 10000.0, 10000.0});
}

vector
cmf_wavelength_to_normalized_color(const float wavelength)
{
    return cmf_wavelength_to_color(wavelength) / CMF_AVG;
}

float
cmf_sample_wavelength(const float sample)
{
    return sample * (CMF_WLEND-CMF_WLSTART) + CMF_WLSTART;
}

#endif
